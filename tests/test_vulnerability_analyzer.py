"""Tests for vulnerability analyzer module."""

import unittest

import pandas as pd

from src.core.vulnerability_analyzer import AttackChainAnalyzer


class TestAttackChainAnalyzer(unittest.TestCase):
    """Test cases for AttackChainAnalyzer class."""

    def setUp(self):
        """Set up test fixtures."""
        self.sample_cve_dataframe = pd.DataFrame(
            {
                "cve_id": ["CVE-2021-1", "CVE-2021-2", "CVE-2021-3"],
                "impact": ["RCE", "Privilege Escalation", "Auth Bypass"],
                "severity": ["Critical", "High", "Medium"],
                "cwe": ["CWE-79", "CWE-79", "CWE-89"],
            }
        )

    def test_analyzer_initialization(self):
        """Test AttackChainAnalyzer initialization."""
        analyzer = AttackChainAnalyzer(self.sample_cve_dataframe)

        self.assertIsNotNone(analyzer.df)
        self.assertIsNotNone(analyzer.attack_graph)
        self.assertGreater(len(analyzer.attack_graph.nodes), 0)

    def test_map_to_mitre_with_impact(self):
        """Test mapping impact to MITRE tactic."""
        result = AttackChainAnalyzer.map_to_mitre("RCE", "")
        self.assertEqual(result, "Execution")

    def test_map_to_mitre_with_cwe(self):
        """Test mapping CWE to MITRE tactic."""
        result = AttackChainAnalyzer.map_to_mitre("", "CWE-79")
        self.assertEqual(result, "Execution")

    def test_map_to_mitre_unknown(self):
        """Test mapping unknown impact/CWE."""
        result = AttackChainAnalyzer.map_to_mitre("Unknown", "CWE-999")
        self.assertEqual(result, "Unknown")

    def test_build_graph(self):
        """Test graph building."""
        analyzer = AttackChainAnalyzer(self.sample_cve_dataframe)

        self.assertEqual(len(analyzer.attack_graph.nodes), 3)
        self.assertIn("mitre_phase", analyzer.df.columns)

    def test_find_unique_chains(self):
        """Test finding unique attack chains."""
        analyzer = AttackChainAnalyzer(self.sample_cve_dataframe)
        chains = analyzer.find_unique_chains()

        self.assertIsInstance(chains, list)

    def test_get_critical_paths(self):
        """Test getting critical paths."""
        analyzer = AttackChainAnalyzer(self.sample_cve_dataframe)
        paths = analyzer.get_critical_paths(min_length=2)

        self.assertIsInstance(paths, list)

    def test_get_node_impact(self):
        """Test getting node impact metrics."""
        analyzer = AttackChainAnalyzer(self.sample_cve_dataframe)
        impact = analyzer.get_node_impact("CVE-2021-1")

        self.assertIn("cve_id", impact)
        self.assertIn("impact", impact)
        self.assertIn("severity", impact)

    def test_get_graph_statistics(self):
        """Test getting graph statistics."""
        analyzer = AttackChainAnalyzer(self.sample_cve_dataframe)
        stats = analyzer.get_graph_statistics()

        self.assertIn("total_nodes", stats)
        self.assertIn("total_edges", stats)
        self.assertIn("density", stats)
        self.assertIn("is_dag", stats)
